import React, { useState, useRef, useEffect } from 'react'
import axios from 'axios'
import './rag-assistant-styles.css'

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:3000'

// í‚¤ì›Œë“œ íƒœê·¸ ë°ì´í„°
const KEYWORD_TAGS = [
  { id: 1, label: '#ê°€ê²©', query: 'ê°€ê²© ë¬¸ì˜' },
  { id: 2, label: '#ìš”ê¸ˆì œ', query: 'ìš”ê¸ˆì œ ë³€ê²½' },
  { id: 3, label: '#ë°ì´í„° ì‚¬ìš©ëŸ‰', query: 'ë°ì´í„° ì‚¬ìš©ëŸ‰' },
  { id: 4, label: '#ë°°ì†¡', query: 'ë°°ì†¡ ì¡°íšŒ' },
  { id: 5, label: '#ë°˜í’ˆ', query: 'ë°˜í’ˆ ì ˆì°¨' },
  { id: 6, label: '#í™˜ë¶ˆ', query: 'í™˜ë¶ˆ ì •ì±…' },
  { id: 7, label: '#ê²°ì œ', query: 'ê²°ì œ ì˜¤ë¥˜' },
  { id: 8, label: '#ì¿ í°', query: 'ì¿ í° ì‚¬ìš©' }
]

export default function RAGAssistant({ messages: conversationMessages, onScriptsChange }) {
  const [scripts, setScripts] = useState([])
  const [input, setInput] = useState('')
  const [loading, setLoading] = useState(false)
  const [history, setHistory] = useState([])
  const [selectedTag, setSelectedTag] = useState(null)
  const [expandedSources, setExpandedSources] = useState({})
  const [lastProcessedIndex, setLastProcessedIndex] = useState(-1)
  const scriptsEndRef = useRef(null)
  const loadingRef = useRef(false)
  const messageQueueRef = useRef([])  // ë©”ì‹œì§€ í
  const processingRef = useRef(false)  // í ì²˜ë¦¬ ì¤‘ ì—¬ë¶€
  const historyRef = useRef([])  // ìµœì‹  history ì°¸ì¡°ìš©

  // history ë³€ê²½ ì‹œ ref ì—…ë°ì´íŠ¸
  useEffect(() => {
    historyRef.current = history
  }, [history])

  // scripts ë³€ê²½ ì‹œ ë¶€ëª¨ì—ê²Œ ì•Œë¦¼
  useEffect(() => {
    if (onScriptsChange) {
      onScriptsChange(scripts)
    }
  }, [scripts, onScriptsChange])

  const scrollToBottom = () => {
    scriptsEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }

  useEffect(() => {
    scrollToBottom()
  }, [scripts])

  // ì‹¤ì‹œê°„ ë©”ì‹œì§€ ê°ì§€ - ê³ ê° ë©”ì‹œì§€ê°€ ì˜¤ë©´ íì— ì¶”ê°€
  useEffect(() => {
    if (!conversationMessages || conversationMessages.length === 0) return
    
    // ì²˜ë¦¬ë˜ì§€ ì•Šì€ ëª¨ë“  ìƒˆ ë©”ì‹œì§€ë¥¼ íì— ì¶”ê°€
    for (let i = lastProcessedIndex + 1; i < conversationMessages.length; i++) {
      const msg = conversationMessages[i]
      if (msg.role === 'user') {
        messageQueueRef.current.push(msg.content)
      }
    }
    
    setLastProcessedIndex(conversationMessages.length - 1)
    
    // í ì²˜ë¦¬ ì‹œì‘
    processQueue()
  }, [conversationMessages])

  // íì—ì„œ ë©”ì‹œì§€ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬
  const processQueue = async () => {
    if (processingRef.current || messageQueueRef.current.length === 0) return
    
    processingRef.current = true
    setLoading(true)
    
    while (messageQueueRef.current.length > 0) {
      const query = messageQueueRef.current.shift()
      await autoFetchScript(query)
    }
    
    processingRef.current = false
    setLoading(false)
  }

  // ìë™ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± í•¨ìˆ˜ (ì‹¤ì‹œê°„ìš©)
  const autoFetchScript = async (query) => {
    if (!query.trim()) return

    try {
      const response = await axios.post(`${API_URL}/rag/chat`, {
        message: query,
        history: historyRef.current  // ìµœì‹  history ì‚¬ìš©
      })

      if (response.data.skipped) {
        console.log(`â­ï¸ ìë™ ê°€ì´ë“œ ìŠ¤í‚µ: ${query}`)
        setHistory(response.data.history)
        historyRef.current = response.data.history
        return
      }

      const newScript = {
        id: Date.now(),
        title: query.length > 30 ? query.substring(0, 30) + '...' : query,
        content: response.data.answer,
        sources: deduplicateSources(response.data.sources || [], 2),
        isAutoGenerated: true
      }
      
      setScripts(prev => [...prev, newScript])
      setHistory(response.data.history)
      historyRef.current = response.data.history

    } catch (error) {
      console.error('Auto RAG Error:', error)
    }
  }

  // íƒœê·¸ í´ë¦­ ì‹œ í•´ë‹¹ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰
  const handleTagClick = async (tag) => {
    if (loading) return
    
    setSelectedTag(tag.id)
    await fetchScript(tag.query)
  }

  // ìŠ¤í¬ë¦½íŠ¸ ìš”ì²­ (ë§¥ë½ ë¶„ì„ í¬í•¨)
  const fetchScript = async (query) => {
    if (!query.trim() || loading) return

    setLoading(true)

    try {
      const response = await axios.post(`${API_URL}/rag/chat`, {
        message: query,
        history: history
      })

      // ë§¥ë½ ë¶„ì„ ê²°ê³¼: SKIPëœ ê²½ìš° ì²˜ë¦¬
      if (response.data.skipped) {
        console.log(`â­ï¸  ê°€ì´ë“œ ìƒì„± ìŠ¤í‚µ: ${query} (ì´ìœ : ${response.data.reason})`)
        // íˆìŠ¤í† ë¦¬ë§Œ ì—…ë°ì´íŠ¸, í™”ë©´ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
        setHistory(response.data.history)
        return
      }

      // GENERATEëœ ê²½ìš°: ì •ìƒì ìœ¼ë¡œ ìŠ¤í¬ë¦½íŠ¸ í‘œì‹œ (ì¤‘ë³µ í˜ì´ì§€ ì œê±°, ìµœëŒ€ 2ê°œ)
      const newScript = {
        id: Date.now(),
        title: query,
        content: response.data.answer,
        sources: deduplicateSources(response.data.sources || [], 2),
        reason: response.data.reason  // ìƒì„± ì´ìœ  ì €ì¥ (ì˜µì…˜)
      }
      
      setScripts(prev => [...prev, newScript])
      setHistory(response.data.history)

    } catch (error) {
      console.error('RAG Error:', error)
      const errorScript = {
        id: Date.now(),
        title: query,
        content: error.response?.status === 503 
          ? 'RAG Agentê°€ ì‹¤í–‰ ì¤‘ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒë‹´ ê°€ì´ë“œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
          : 'ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ì‹œìŠ¤í…œ ë¬¸ì œë¡œ ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        sources: [],
        isError: true
      }
      setScripts(prev => [...prev, errorScript])
    } finally {
      setLoading(false)
    }
  }

  const handleSend = async () => {
    if (!input.trim() || loading) return
    
    const query = input.trim()
    setInput('')
    await fetchScript(query)
  }

  const handleKeyPress = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      handleSend()
    }
  }

  const clearScripts = () => {
    setScripts([])
    setHistory([])
    setSelectedTag(null)
    setExpandedSources({})
  }

  const toggleSource = (scriptId, sourceIdx) => {
    const key = `${scriptId}-${sourceIdx}`
    setExpandedSources(prev => ({
      ...prev,
      [key]: !prev[key]
    }))
  }

  // ì¤‘ë³µ í˜ì´ì§€ ì œê±° ë° ìµœëŒ€ 2ê°œë§Œ ë°˜í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
  const deduplicateSources = (sources, maxCount = 2) => {
    if (!sources || sources.length === 0) return []
    
    const seenPages = new Set()
    const uniqueSources = []
    
    for (const source of sources) {
      const pageKey = source.page || source.content?.substring(0, 50) // í˜ì´ì§€ ë²ˆí˜¸ ë˜ëŠ” ë‚´ìš© ì¼ë¶€ë¡œ ì¤‘ë³µ ì²´í¬
      if (!seenPages.has(pageKey)) {
        seenPages.add(pageKey)
        uniqueSources.push(source)
        if (uniqueSources.length >= maxCount) break
      }
    }
    
    return uniqueSources
  }

  // í‚¤ì›Œë“œ í´ë¦­ ì‹œ ë§¤ë‰´ì–¼ë§Œ ê²€ìƒ‰
  const handleKeywordClick = async (keyword) => {
    if (loading) return

    setLoading(true)

    try {
      // ë§¤ë‰´ì–¼ ê²€ìƒ‰ API í˜¸ì¶œ (LLM ë‹µë³€ ìƒì„± ì—†ì´)
      const response = await axios.post(`${API_URL}/rag/search`, {
        query: keyword,
        k: 2 // ê°€ì¥ ê´€ë ¨ë„ ë†’ì€ 1~2ê°œ ë§¤ë‰´ì–¼ë§Œ ê°€ì ¸ì˜¤ê¸°
      })

      // ë§¤ë‰´ì–¼ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ìŠ¤í¬ë¦½íŠ¸ë¡œ í‘œì‹œ (ì¤‘ë³µ í˜ì´ì§€ ì œê±°, ìµœëŒ€ 2ê°œ)
      const uniqueSources = deduplicateSources(response.data.sources || [], 2)
      const manualScript = {
        id: Date.now(),
        title: `ğŸ“– "${keyword}" ê´€ë ¨ ë§¤ë‰´ì–¼`,
        content: uniqueSources.map((s, idx) => 
          `[ë§¤ë‰´ì–¼ ${s.page && s.page !== 'N/A' ? `p.${s.page}` : idx + 1}]\n${s.content}`
        ).join('\n\n') || 'ë§¤ë‰´ì–¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        sources: uniqueSources,
        isManual: true
      }
      setScripts(prev => [...prev, manualScript])

    } catch (error) {
      console.error('Manual Search Error:', error)
      const errorScript = {
        id: Date.now(),
        title: `"${keyword}" ë§¤ë‰´ì–¼ ê²€ìƒ‰`,
        content: error.response?.status === 503 
          ? 'RAG Agentê°€ ì‹¤í–‰ ì¤‘ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë§¤ë‰´ì–¼ ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
          : 'ë§¤ë‰´ì–¼ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
        sources: [],
        isError: true
      }
      setScripts(prev => [...prev, errorScript])
    } finally {
      setLoading(false)
    }
  }
  return (
    <div className="rag-container">
      {/* Header */}
      <div className="rag-header">
        <h2>AI ì¶”ì²œ ìŠ¤í¬ë¦½íŠ¸</h2>
        {scripts.length > 0 && (
          <button className="clear-btn" onClick={clearScripts}>
            <span className="material-icons-outlined">refresh</span>
            ì´ˆê¸°í™”
          </button>
        )}
      </div>

      {/* Tag Chips */}
      <div className="tag-chips">
        {KEYWORD_TAGS.map(tag => (
          <button
            key={tag.id}
            className={`tag-chip ${selectedTag === tag.id ? 'active' : ''}`}
            onClick={() => handleTagClick(tag)}
            disabled={loading}
          >
            {tag.label}
          </button>
        ))}
      </div>

      {/* Scripts List */}
      <div className="scripts-container">
        {scripts.length === 0 && !loading && (
          <div className="empty-scripts">
            <span className="material-icons-outlined">auto_awesome</span>
            <p><strong>ì‹¤ì‹œê°„ ìƒë‹´ ê°€ì´ë“œ</strong></p>
            <p>íƒœê·¸ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì‹œë©´</p>
            <p>AIê°€ ìƒë‹´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.</p>
          </div>
        )}

        {scripts.map((script, idx) => (
          <div 
            key={script.id} 
            className={`script-card ${idx === 0 ? 'highlight' : ''} ${script.isError ? 'error' : ''} ${script.isManual ? 'manual' : ''}`}
          >
            <h3 className="script-title">
              {script.title}
            </h3>
            <p className="script-content">{script.content}</p>
            
            <div className="script-footer">
              {script.sources && script.sources.length > 0 && (
                <div className="source-links">
                  {script.sources.map((source, sourceIdx) => {
                    const key = `${script.id}-${sourceIdx}`
                    const isExpanded = expandedSources[key]
                    
                    return (
                      <div key={sourceIdx} className="source-item">
                        <button 
                          className="source-link"
                          onClick={() => toggleSource(script.id, sourceIdx)}
                        >
                          <span className="material-icons-outlined source-icon">
                            {source.page ? 'picture_as_pdf' : 'description'}
                          </span>
                          <span>
                            {source.page && source.page !== 'N/A' 
                              ? `ë§¤ë‰´ì–¼ p.${source.page}` 
                              : 'ì°¸ì¡° ë¬¸ì„œ'}
                          </span>
                          <span className="material-icons-outlined expand-icon">
                            {isExpanded ? 'expand_less' : 'expand_more'}
                          </span>
                        </button>
                        
                        {isExpanded && (
                          <div className="source-content">
                            {source.content}
                          </div>
                        )}
                      </div>
                    )
                  })}
                </div>
              )}
            </div>
          </div>
        ))}

        {loading && (
          <div className="script-card loading">
            <div className="loading-content">
              <div className="loader"></div>
              <span>ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì¤‘...</span>
            </div>
          </div>
        )}

        <div ref={scriptsEndRef} />
      </div>

      {/* Input Area */}
      <div className="input-container">
        <input
          type="text"
          className="script-input"
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyPress={handleKeyPress}
          placeholder="ê³ ê° ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
          disabled={loading}
        />
        <button
          className="send-btn"
          onClick={handleSend}
          disabled={loading || !input.trim()}
        >
          <span className="material-icons-outlined">send</span>
        </button>
      </div>
    </div>
  )
}
